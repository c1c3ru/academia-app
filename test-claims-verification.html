<!DOCTYPE html>
<html>
<head>
    <title>Verifica√ß√£o de Claims</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; }
        .success { color: #0f5132; background: #d1e7dd; }
        .error { color: #842029; background: #f8d7da; }
        .button { background: #4285f4; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üîç Verifica√ß√£o de Custom Claims</h1>
    <button class="button" onclick="testClaims()">Testar Claims</button>
    <button class="button" onclick="testFirestoreAccess()">Testar Firestore</button>
    <div id="log" class="log"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA_hzFPt9hUITlMq9BrsJuxAdzycVR3AEI",
            authDomain: "academia-app-5cf79.firebaseapp.com",
            projectId: "academia-app-5cf79",
            storageBucket: "academia-app-5cf79.firebasestorage.app",
            messagingSenderId: "377489252583",
            appId: "1:377489252583:android:87f2c3948511325769c242"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                log(`‚úÖ Usu√°rio logado: ${user.email}`, 'success');
                log(`üìã UID: ${user.uid}`);
            } else {
                log('‚ùå Usu√°rio n√£o logado', 'error');
            }
        });

        window.testClaims = async function() {
            if (!currentUser) {
                log('‚ùå Usu√°rio n√£o logado', 'error');
                return;
            }

            try {
                log('üîç Verificando Custom Claims...');
                const tokenResult = await currentUser.getIdTokenResult(true);
                
                log(`üìã Claims completos: ${JSON.stringify(tokenResult.claims, null, 2)}`);
                
                if (tokenResult.claims.role && tokenResult.claims.academiaId) {
                    log(`‚úÖ Claims v√°lidos: role=${tokenResult.claims.role}, academiaId=${tokenResult.claims.academiaId}`, 'success');
                } else {
                    log('‚ùå Claims inv√°lidos ou ausentes', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro ao verificar claims: ${error.message}`, 'error');
            }
        };

        window.testFirestoreAccess = async function() {
            if (!currentUser) {
                log('‚ùå Usu√°rio n√£o logado', 'error');
                return;
            }

            try {
                log('üß™ Testando acesso ao Firestore...');
                
                // Testar acesso √† cole√ß√£o users
                try {
                    const usersSnapshot = await getDocs(collection(db, 'users'));
                    log(`‚úÖ Acesso √† cole√ß√£o users: ${usersSnapshot.size} documentos`, 'success');
                } catch (error) {
                    log(`‚ùå Erro ao acessar users: ${error.message}`, 'error');
                }
                
                // Testar acesso √† academia espec√≠fica
                try {
                    const academiaDoc = await getDoc(doc(db, 'gyms', 'Tgg6tZynnTbQUxeAFJAB'));
                    if (academiaDoc.exists()) {
                        log(`‚úÖ Acesso √† academia: ${academiaDoc.data().name}`, 'success');
                    } else {
                        log('‚ö†Ô∏è Academia n√£o encontrada', 'error');
                    }
                } catch (error) {
                    log(`‚ùå Erro ao acessar academia: ${error.message}`, 'error');
                }
                
                // Testar acesso √†s notifica√ß√µes
                try {
                    const notificationsSnapshot = await getDocs(collection(db, 'gyms', 'Tgg6tZynnTbQUxeAFJAB', 'notifications'));
                    log(`‚úÖ Acesso √†s notifica√ß√µes: ${notificationsSnapshot.size} documentos`, 'success');
                } catch (error) {
                    log(`‚ùå Erro ao acessar notifica√ß√µes: ${error.message}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro geral no teste: ${error.message}`, 'error');
            }
        };

        log('üöÄ P√°gina carregada. Aguardando autentica√ß√£o...');
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Alunos - Academia App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .section h3 {
            margin-top: 0;
            color: #2196F3;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            color: #f44336;
            background: #ffebee;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: #4CAF50;
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .warning {
            color: #ff9800;
            background: #fff3e0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .input-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de Alunos - Academia App</h1>
        
        <div class="section">
            <h3>üìã Configura√ß√£o</h3>
            <div class="input-group">
                <label for="academiaId">ID da Academia:</label>
                <input type="text" id="academiaId" placeholder="Digite o ID da sua academia (ex: gym_123)" />
            </div>
            <button onclick="iniciarDiagnostico()">üîç Iniciar Diagn√≥stico</button>
            <button onclick="verificarEstrutura()">üèóÔ∏è Verificar Estrutura</button>
            <button onclick="migrarDados()">üîÑ Migrar Dados</button>
        </div>

        <div class="section">
            <h3>üìä Resultados do Diagn√≥stico</h3>
            <div id="results" class="results">
Clique em "Iniciar Diagn√≥stico" para verificar os dados dos alunos...
            </div>
        </div>

        <div class="section">
            <h3>üõ†Ô∏è A√ß√µes de Corre√ß√£o</h3>
            <button onclick="criarAlunoTeste()" disabled id="btnCriarTeste">üë§ Criar Aluno de Teste</button>
            <button onclick="associarAlunosATurmas()" disabled id="btnAssociar">üîó Associar Alunos √†s Turmas</button>
            <button onclick="limparCache()">üóëÔ∏è Limpar Cache</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDocs, 
            getDoc,
            setDoc,
            addDoc,
            query, 
            where,
            orderBy,
            updateDoc
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Configura√ß√£o do Firebase (substitua pela sua configura√ß√£o)
        const firebaseConfig = {
            apiKey: "AIzaSyBEWjKmKzqFhYJjZhHNqPKKKKKKKKKKKKK",
            authDomain: "academia-app-12345.firebaseapp.com",
            projectId: "academia-app-12345",
            storageBucket: "academia-app-12345.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdefghijklmnop"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Tornar fun√ß√µes globais
        window.db = db;
        window.collection = collection;
        window.doc = doc;
        window.getDocs = getDocs;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.addDoc = addDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.updateDoc = updateDoc;

        console.log('Firebase inicializado com sucesso');
    </script>

    <script>
        let diagnosticoCompleto = false;

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            let prefix = '';
            
            switch(type) {
                case 'error':
                    prefix = '‚ùå ERRO';
                    break;
                case 'success':
                    prefix = '‚úÖ SUCESSO';
                    break;
                case 'warning':
                    prefix = '‚ö†Ô∏è AVISO';
                    break;
                case 'info':
                default:
                    prefix = '‚ÑπÔ∏è INFO';
                    break;
            }
            
            results.textContent += `[${timestamp}] ${prefix}: ${message}\n`;
            results.scrollTop = results.scrollHeight;
        }

        function clearLog() {
            document.getElementById('results').textContent = '';
        }

        async function iniciarDiagnostico() {
            clearLog();
            const academiaId = document.getElementById('academiaId').value.trim();
            
            if (!academiaId) {
                log('Por favor, insira o ID da academia', 'error');
                return;
            }

            log('Iniciando diagn√≥stico completo...');
            log(`Academia ID: ${academiaId}`);

            try {
                // 1. Verificar se a academia existe
                log('\n=== 1. VERIFICANDO ACADEMIA ===');
                const academiaRef = doc(db, 'gyms', academiaId);
                const academiaSnap = await getDoc(academiaRef);
                
                if (academiaSnap.exists()) {
                    const academiaData = academiaSnap.data();
                    log(`‚úÖ Academia encontrada: ${academiaData.name || 'Sem nome'}`, 'success');
                } else {
                    log('‚ùå Academia n√£o encontrada na cole√ß√£o gyms', 'error');
                    
                    // Tentar na cole√ß√£o alternativa
                    const academiaAltRef = doc(db, 'academias', academiaId);
                    const academiaAltSnap = await getDoc(academiaAltRef);
                    
                    if (academiaAltSnap.exists()) {
                        log('‚ö†Ô∏è Academia encontrada na cole√ß√£o "academias" (estrutura antiga)', 'warning');
                    } else {
                        log('‚ùå Academia n√£o encontrada em nenhuma cole√ß√£o', 'error');
                        return;
                    }
                }

                // 2. Verificar alunos na cole√ß√£o global
                log('\n=== 2. VERIFICANDO ALUNOS NA COLE√á√ÉO GLOBAL ===');
                const globalStudentsRef = collection(db, 'users');
                const globalStudentsQuery = query(globalStudentsRef, where('userType', '==', 'student'));
                const globalStudentsSnap = await getDocs(globalStudentsQuery);
                
                log(`Alunos encontrados na cole√ß√£o global 'users': ${globalStudentsSnap.size}`);
                
                let alunosComAcademia = 0;
                let alunosDestaAcademia = 0;
                
                globalStudentsSnap.forEach((doc) => {
                    const data = doc.data();
                    if (data.academiaId) {
                        alunosComAcademia++;
                        if (data.academiaId === academiaId) {
                            alunosDestaAcademia++;
                        }
                    }
                });
                
                log(`Alunos com academiaId definido: ${alunosComAcademia}`);
                log(`Alunos desta academia: ${alunosDestaAcademia}`);

                // 3. Verificar alunos na subcole√ß√£o da academia
                log('\n=== 3. VERIFICANDO ALUNOS NA SUBCOLE√á√ÉO ===');
                const subStudentsRef = collection(db, 'gyms', academiaId, 'students');
                const subStudentsSnap = await getDocs(subStudentsRef);
                
                log(`Alunos na subcole√ß√£o gyms/${academiaId}/students: ${subStudentsSnap.size}`);
                
                if (subStudentsSnap.size > 0) {
                    log('Lista de alunos na subcole√ß√£o:');
                    subStudentsSnap.forEach((doc) => {
                        const data = doc.data();
                        log(`  - ${data.name || 'Sem nome'} (${data.email || 'Sem email'})`);
                    });
                }

                // 4. Verificar turmas
                log('\n=== 4. VERIFICANDO TURMAS ===');
                const classesRef = collection(db, 'gyms', academiaId, 'classes');
                const classesSnap = await getDocs(classesRef);
                
                log(`Turmas na subcole√ß√£o gyms/${academiaId}/classes: ${classesSnap.size}`);
                
                if (classesSnap.size > 0) {
                    log('Lista de turmas:');
                    classesSnap.forEach((doc) => {
                        const data = doc.data();
                        log(`  - ${data.name || 'Sem nome'} (Instrutor: ${data.instructorId || 'N√£o definido'})`);
                    });
                }

                // 5. Verificar modalidades
                log('\n=== 5. VERIFICANDO MODALIDADES ===');
                const modalitiesRef = collection(db, 'gyms', academiaId, 'modalities');
                const modalitiesSnap = await getDocs(modalitiesRef);
                
                log(`Modalidades na subcole√ß√£o: ${modalitiesSnap.size}`);

                // 6. Verificar planos
                log('\n=== 6. VERIFICANDO PLANOS ===');
                const plansRef = collection(db, 'gyms', academiaId, 'plans');
                const plansSnap = await getDocs(plansRef);
                
                log(`Planos na subcole√ß√£o: ${plansSnap.size}`);

                // 7. Diagn√≥stico final
                log('\n=== 7. DIAGN√ìSTICO FINAL ===');
                
                if (subStudentsSnap.size === 0 && alunosDestaAcademia > 0) {
                    log('üîç PROBLEMA IDENTIFICADO: Alunos existem na cole√ß√£o global mas n√£o na subcole√ß√£o', 'warning');
                    log('üí° SOLU√á√ÉO: Execute a migra√ß√£o de dados', 'info');
                } else if (subStudentsSnap.size === 0 && alunosDestaAcademia === 0) {
                    log('üîç PROBLEMA IDENTIFICADO: Nenhum aluno cadastrado', 'warning');
                    log('üí° SOLU√á√ÉO: Cadastre alunos ou crie um aluno de teste', 'info');
                } else if (subStudentsSnap.size > 0) {
                    log('‚úÖ Alunos encontrados na estrutura correta', 'success');
                    
                    // Verificar se alunos t√™m associa√ß√£o com turmas
                    let alunosComTurmas = 0;
                    subStudentsSnap.forEach((doc) => {
                        const data = doc.data();
                        if (data.classIds && data.classIds.length > 0) {
                            alunosComTurmas++;
                        }
                    });
                    
                    log(`Alunos associados a turmas: ${alunosComTurmas}/${subStudentsSnap.size}`);
                    
                    if (alunosComTurmas === 0 && classesSnap.size > 0) {
                        log('‚ö†Ô∏è PROBLEMA: Alunos n√£o est√£o associados a turmas', 'warning');
                        log('üí° SOLU√á√ÉO: Execute a associa√ß√£o autom√°tica', 'info');
                    }
                }

                diagnosticoCompleto = true;
                document.getElementById('btnCriarTeste').disabled = false;
                document.getElementById('btnAssociar').disabled = false;
                
                log('\n‚úÖ Diagn√≥stico conclu√≠do!', 'success');

            } catch (error) {
                log(`Erro durante o diagn√≥stico: ${error.message}`, 'error');
                console.error('Erro:', error);
            }
        }

        async function verificarEstrutura() {
            clearLog();
            const academiaId = document.getElementById('academiaId').value.trim();
            
            if (!academiaId) {
                log('Por favor, insira o ID da academia', 'error');
                return;
            }

            log('Verificando estrutura de cole√ß√µes...');

            try {
                const colecoes = ['students', 'classes', 'instructors', 'modalities', 'plans', 'announcements', 'payments', 'graduations'];
                
                for (const colecao of colecoes) {
                    const ref = collection(db, 'gyms', academiaId, colecao);
                    const snap = await getDocs(ref);
                    log(`${colecao}: ${snap.size} documentos`);
                }

            } catch (error) {
                log(`Erro ao verificar estrutura: ${error.message}`, 'error');
            }
        }

        async function migrarDados() {
            const academiaId = document.getElementById('academiaId').value.trim();
            
            if (!academiaId) {
                log('Por favor, insira o ID da academia', 'error');
                return;
            }

            if (!confirm('Deseja migrar os dados da cole√ß√£o global para as subcole√ß√µes? Esta opera√ß√£o pode demorar alguns minutos.')) {
                return;
            }

            log('Iniciando migra√ß√£o de dados...');

            try {
                // Migrar alunos
                log('Migrando alunos...');
                const globalStudentsRef = collection(db, 'users');
                const globalStudentsQuery = query(globalStudentsRef, 
                    where('userType', '==', 'student'),
                    where('academiaId', '==', academiaId)
                );
                const globalStudentsSnap = await getDocs(globalStudentsQuery);
                
                let migrados = 0;
                for (const docSnap of globalStudentsSnap.docs) {
                    const data = docSnap.data();
                    const subStudentRef = doc(db, 'gyms', academiaId, 'students', docSnap.id);
                    await setDoc(subStudentRef, {
                        ...data,
                        migratedAt: new Date()
                    });
                    migrados++;
                }
                
                log(`‚úÖ ${migrados} alunos migrados para subcole√ß√£o`, 'success');

                // Verificar outras cole√ß√µes globais
                const colecoesGlobais = ['modalities', 'plans', 'announcements'];
                
                for (const colecao of colecoesGlobais) {
                    log(`Verificando ${colecao} globais...`);
                    const globalRef = collection(db, colecao);
                    const globalQuery = query(globalRef, where('academiaId', '==', academiaId));
                    const globalSnap = await getDocs(globalQuery);
                    
                    if (globalSnap.size > 0) {
                        log(`Migrando ${globalSnap.size} ${colecao}...`);
                        for (const docSnap of globalSnap.docs) {
                            const data = docSnap.data();
                            const subRef = doc(db, 'gyms', academiaId, colecao, docSnap.id);
                            await setDoc(subRef, {
                                ...data,
                                migratedAt: new Date()
                            });
                        }
                        log(`‚úÖ ${colecao} migrados`, 'success');
                    } else {
                        log(`Nenhum ${colecao} encontrado para migrar`);
                    }
                }

                log('‚úÖ Migra√ß√£o conclu√≠da! Execute o diagn√≥stico novamente.', 'success');

            } catch (error) {
                log(`Erro durante migra√ß√£o: ${error.message}`, 'error');
            }
        }

        async function criarAlunoTeste() {
            const academiaId = document.getElementById('academiaId').value.trim();
            
            if (!academiaId) {
                log('Por favor, insira o ID da academia', 'error');
                return;
            }

            log('Criando aluno de teste...');

            try {
                const alunoTeste = {
                    name: 'Aluno Teste',
                    email: 'aluno.teste@exemplo.com',
                    phone: '(11) 99999-9999',
                    userType: 'student',
                    academiaId: academiaId,
                    isActive: true,
                    currentGraduation: 'Iniciante',
                    classIds: [],
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                // Criar na subcole√ß√£o
                const subStudentRef = collection(db, 'gyms', academiaId, 'students');
                const docRef = await addDoc(subStudentRef, alunoTeste);
                
                log(`‚úÖ Aluno de teste criado com ID: ${docRef.id}`, 'success');

            } catch (error) {
                log(`Erro ao criar aluno de teste: ${error.message}`, 'error');
            }
        }

        async function associarAlunosATurmas() {
            const academiaId = document.getElementById('academiaId').value.trim();
            
            if (!academiaId) {
                log('Por favor, insira o ID da academia', 'error');
                return;
            }

            log('Associando alunos √†s turmas...');

            try {
                // Buscar turmas
                const classesRef = collection(db, 'gyms', academiaId, 'classes');
                const classesSnap = await getDocs(classesRef);
                
                if (classesSnap.size === 0) {
                    log('Nenhuma turma encontrada', 'warning');
                    return;
                }

                // Buscar alunos
                const studentsRef = collection(db, 'gyms', academiaId, 'students');
                const studentsSnap = await getDocs(studentsRef);
                
                if (studentsSnap.size === 0) {
                    log('Nenhum aluno encontrado', 'warning');
                    return;
                }

                // Associar cada aluno √† primeira turma dispon√≠vel
                const primeiraTurma = classesSnap.docs[0];
                const turmaId = primeiraTurma.id;
                const turmaNome = primeiraTurma.data().name;
                
                log(`Associando alunos √† turma: ${turmaNome}`);

                let associados = 0;
                for (const studentDoc of studentsSnap.docs) {
                    const studentData = studentDoc.data();
                    
                    // Verificar se j√° tem turmas
                    if (!studentData.classIds || studentData.classIds.length === 0) {
                        await updateDoc(doc(db, 'gyms', academiaId, 'students', studentDoc.id), {
                            classIds: [turmaId],
                            updatedAt: new Date()
                        });
                        associados++;
                    }
                }

                log(`‚úÖ ${associados} alunos associados √† turma`, 'success');

            } catch (error) {
                log(`Erro ao associar alunos: ${error.message}`, 'error');
            }
        }

        function limparCache() {
            if (confirm('Deseja limpar o cache do navegador? Isso pode ajudar a resolver problemas de carregamento.')) {
                localStorage.clear();
                sessionStorage.clear();
                log('‚úÖ Cache limpo', 'success');
                log('Recarregue a p√°gina do app para ver as mudan√ßas');
            }
        }
    </script>
</body>
</html>

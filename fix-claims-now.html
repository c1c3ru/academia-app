<!DOCTYPE html>
<html>
<head>
    <title>Corre√ß√£o Imediata de Claims</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .button { background: #4285f4; color: white; border: none; padding: 15px 30px; margin: 10px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .button:hover { background: #3367d6; }
        .log { background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .success { color: #0f5132; background: #d1e7dd; }
        .error { color: #842029; background: #f8d7da; }
    </style>
</head>
<body>
    <h1>üö® Corre√ß√£o Imediata de Custom Claims</h1>
    <p><strong>Usu√°rio ID:</strong> rnrDk4ZCuERLDlSNAiYmMGS431T2</p>
    <p><strong>Academia ID:</strong> Tgg6tZynnTbQUxeAFJAB</p>
    
    <button class="button" onclick="doLogin()">üîê FAZER LOGIN</button>
    <button class="button" onclick="fixClaimsNow()">üîß CORRIGIR CLAIMS AGORA</button>
    <button class="button" onclick="checkClaims()">üîç Verificar Claims</button>
    <button class="button" onclick="testAccess()">üß™ Testar Acesso</button>
    
    <div id="log" class="log"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA_hzFPt9hUITlMq9BrsJuxAdzycVR3AEI",
            authDomain: "academia-app-5cf79.firebaseapp.com",
            projectId: "academia-app-5cf79",
            storageBucket: "academia-app-5cf79.firebasestorage.app",
            messagingSenderId: "377489252583",
            appId: "1:377489252583:android:87f2c3948511325769c242"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Fun√ß√£o de login manual
        window.doLogin = async function() {
            try {
                log('üîê Fazendo login...');
                const email = prompt('Email:', 'cicerosilva.ifce@gmail.com');
                const password = prompt('Senha:');
                
                if (email && password) {
                    await signInWithEmailAndPassword(auth, email, password);
                    log('‚úÖ Login realizado com sucesso!', 'success');
                    log('üéØ Agora voc√™ pode executar a corre√ß√£o de claims', 'success');
                } else {
                    log('‚ùå Email ou senha n√£o fornecidos', 'error');
                }
            } catch (error) {
                log(`‚ùå Erro no login: ${error.message}`, 'error');
            }
        };

        window.fixClaimsNow = async function() {
            try {
                log('üîß Executando corre√ß√£o de claims...');
                
                const fixUserClaims = httpsCallable(functions, 'fixUserClaims');
                const result = await fixUserClaims({ userId: 'rnrDk4ZCuERLDlSNAiYmMGS431T2' });
                
                log(`‚úÖ Claims corrigidos: ${JSON.stringify(result.data, null, 2)}`, 'success');
                log('üîÑ Aguarde 30 segundos e recarregue o app principal', 'success');
                
            } catch (error) {
                log(`‚ùå Erro na corre√ß√£o: ${error.message}`, 'error');
                
                // Tentar migra√ß√£o completa como fallback
                try {
                    log('üîÑ Tentando migra√ß√£o completa...');
                    const migrateUsers = httpsCallable(functions, 'migrateExistingUsers');
                    const migrateResult = await migrateUsers();
                    log(`‚úÖ Migra√ß√£o completa: ${JSON.stringify(migrateResult.data, null, 2)}`, 'success');
                } catch (migrateError) {
                    log(`‚ùå Erro na migra√ß√£o: ${migrateError.message}`, 'error');
                }
            }
        };

        window.checkClaims = async function() {
            try {
                log('üîç Verificando claims atuais...');
                const user = auth.currentUser;
                if (!user) {
                    log('‚ùå Usu√°rio n√£o logado', 'error');
                    return;
                }
                
                const tokenResult = await user.getIdTokenResult(true);
                log(`üìã Claims: ${JSON.stringify(tokenResult.claims, null, 2)}`);
                
                if (tokenResult.claims.academiaId && tokenResult.claims.role) {
                    log('‚úÖ Claims est√£o configurados!', 'success');
                } else {
                    log('‚ùå Claims n√£o configurados', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        };

        window.testAccess = async function() {
            try {
                log('üß™ Testando acesso ao Firestore...');
                
                const academiaDoc = await getDoc(doc(db, 'gyms', 'Tgg6tZynnTbQUxeAFJAB'));
                if (academiaDoc.exists()) {
                    log('‚úÖ Acesso √† academia funcionando!', 'success');
                } else {
                    log('‚ùå Academia n√£o encontrada', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro de acesso: ${error.message}`, 'error');
            }
        };

        log('üöÄ P√°gina carregada. Clique em "FAZER LOGIN" para come√ßar.');
        log('üìã Sequ√™ncia: 1) Login ‚Üí 2) Corrigir Claims ‚Üí 3) Verificar ‚Üí 4) Testar');
    </script>
</body>
</html>

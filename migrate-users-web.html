<!DOCTYPE html>
<html>
<head>
    <title>Migrar Usu√°rios - Custom Claims</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .button { background: #4285f4; color: white; border: none; padding: 15px 30px; margin: 10px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .button:hover { background: #3367d6; }
        .button:disabled { background: #ccc; cursor: not-allowed; }
        .log { background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .success { color: #0f5132; background: #d1e7dd; }
        .error { color: #842029; background: #f8d7da; }
        .warning { color: #664d03; background: #fff3cd; }
        .info { color: #055160; background: #cff4fc; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .step h3 { margin-top: 0; }
    </style>
</head>
<body>
    <h1>üîß Migra√ß√£o de Usu√°rios - Custom Claims</h1>
    <p>Esta ferramenta ir√° configurar os custom claims para todos os usu√°rios existentes no sistema.</p>
    
    <div class="step">
        <h3>Passo 1: Login</h3>
        <p>Fa√ßa login com um usu√°rio admin para executar a migra√ß√£o.</p>
        <button class="button" onclick="doLogin()" id="loginBtn">üîê Fazer Login</button>
        <div id="loginStatus"></div>
    </div>
    
    <div class="step">
        <h3>Passo 2: Verificar Claims Atuais</h3>
        <p>Verifique os custom claims do usu√°rio logado.</p>
        <button class="button" onclick="checkCurrentClaims()" id="checkBtn" disabled>üîç Verificar Claims</button>
    </div>
    
    <div class="step">
        <h3>Passo 3: Executar Migra√ß√£o</h3>
        <p>Execute a migra√ß√£o para configurar claims de todos os usu√°rios.</p>
        <button class="button" onclick="migrateUsers()" id="migrateBtn" disabled>üöÄ Migrar Usu√°rios</button>
    </div>
    
    <div class="step">
        <h3>Passo 4: Testar Acesso</h3>
        <p>Teste se o acesso ao Firestore est√° funcionando.</p>
        <button class="button" onclick="testFirestoreAccess()" id="testBtn" disabled>üß™ Testar Acesso</button>
    </div>
    
    <div id="log" class="log"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA_hzFPt9hUITlMq9BrsJuxAdzycVR3AEI",
            authDomain: "academia-app-5cf79.firebaseapp.com",
            projectId: "academia-app-5cf79",
            storageBucket: "academia-app-5cf79.firebasestorage.app",
            messagingSenderId: "377489252583",
            appId: "1:377489252583:android:87f2c3948511325769c242"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);

        let currentUser = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateButtonStates() {
            const isLoggedIn = !!currentUser;
            document.getElementById('checkBtn').disabled = !isLoggedIn;
            document.getElementById('migrateBtn').disabled = !isLoggedIn;
            document.getElementById('testBtn').disabled = !isLoggedIn;
            document.getElementById('loginBtn').textContent = isLoggedIn ? '‚úÖ Logado' : 'üîê Fazer Login';
        }

        // Monitor auth state
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateButtonStates();
            
            if (user) {
                document.getElementById('loginStatus').innerHTML = `<div class="success">‚úÖ Logado como: ${user.email}</div>`;
                log(`‚úÖ Usu√°rio logado: ${user.email}`, 'success');
            } else {
                document.getElementById('loginStatus').innerHTML = '';
            }
        });

        window.doLogin = async function() {
            try {
                if (currentUser) {
                    log('‚ÑπÔ∏è Usu√°rio j√° est√° logado', 'info');
                    return;
                }

                const email = prompt('Email do usu√°rio admin:', 'admin@example.com');
                const password = prompt('Senha:');
                
                if (!email || !password) {
                    log('‚ùå Email ou senha n√£o fornecidos', 'error');
                    return;
                }

                log('üîê Fazendo login...');
                await signInWithEmailAndPassword(auth, email, password);
                log('‚úÖ Login realizado com sucesso!', 'success');
                
            } catch (error) {
                log(`‚ùå Erro no login: ${error.message}`, 'error');
                log('üí° Verifique se o email e senha est√£o corretos', 'warning');
            }
        };

        window.checkCurrentClaims = async function() {
            try {
                if (!currentUser) {
                    log('‚ùå Usu√°rio n√£o est√° logado', 'error');
                    return;
                }

                log('üîç Verificando custom claims...');
                const idTokenResult = await currentUser.getIdTokenResult(true);
                
                log(`üìã Claims atuais:`, 'info');
                log(`   UID: ${currentUser.uid}`);
                log(`   Email: ${currentUser.email}`);
                log(`   Role: ${idTokenResult.claims.role || 'n√£o definido'}`);
                log(`   Academia ID: ${idTokenResult.claims.academiaId || 'n√£o definido'}`);
                
                const hasValidClaims = !!(idTokenResult.claims.role && idTokenResult.claims.academiaId);
                
                if (hasValidClaims) {
                    log('‚úÖ Claims est√£o configurados!', 'success');
                } else {
                    log('‚ö†Ô∏è Claims n√£o est√£o completamente configurados', 'warning');
                    log('üí° Execute a migra√ß√£o para configurar os claims', 'info');
                }
                
            } catch (error) {
                log(`‚ùå Erro ao verificar claims: ${error.message}`, 'error');
            }
        };

        window.migrateUsers = async function() {
            try {
                if (!currentUser) {
                    log('‚ùå Usu√°rio n√£o est√° logado', 'error');
                    return;
                }

                log('üöÄ Iniciando migra√ß√£o de usu√°rios...');
                log('‚è≥ Esta opera√ß√£o pode levar alguns minutos...', 'warning');
                
                const migrateFunction = httpsCallable(functions, 'migrateExistingUsers');
                const result = await migrateFunction();
                
                log(`‚úÖ Migra√ß√£o conclu√≠da com sucesso!`, 'success');
                log(`üìä Usu√°rios migrados: ${result.data.migratedUsers}`, 'success');
                log('üîÑ Aguarde 30 segundos para que os tokens sejam atualizados...', 'info');
                
                // Auto-check claims after migration
                setTimeout(() => {
                    log('üîÑ Verificando claims ap√≥s migra√ß√£o...', 'info');
                    checkCurrentClaims();
                }, 2000);
                
            } catch (error) {
                log(`‚ùå Erro na migra√ß√£o: ${error.message}`, 'error');
                log('üí° Verifique se o usu√°rio tem permiss√µes adequadas', 'warning');
            }
        };

        window.testFirestoreAccess = async function() {
            try {
                if (!currentUser) {
                    log('‚ùå Usu√°rio n√£o est√° logado', 'error');
                    return;
                }

                log('üß™ Testando acesso ao Firestore...');
                
                // Test access to user document
                try {
                    const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                    if (userDoc.exists()) {
                        log('‚úÖ Acesso ao documento do usu√°rio: OK', 'success');
                        const userData = userDoc.data();
                        log(`   Nome: ${userData.name || 'n√£o definido'}`);
                        log(`   Tipo: ${userData.userType || userData.tipo || 'n√£o definido'}`);
                        log(`   Academia ID: ${userData.academiaId || 'n√£o definido'}`);
                    } else {
                        log('‚ö†Ô∏è Documento do usu√°rio n√£o encontrado', 'warning');
                    }
                } catch (userError) {
                    log(`‚ùå Erro ao acessar documento do usu√°rio: ${userError.message}`, 'error');
                }
                
                // Test access to gyms collection
                try {
                    const gymsSnapshot = await getDocs(collection(db, 'gyms'));
                    log(`‚úÖ Acesso √† cole√ß√£o gyms: OK (${gymsSnapshot.size} academias)`, 'success');
                } catch (gymsError) {
                    log(`‚ùå Erro ao acessar cole√ß√£o gyms: ${gymsError.message}`, 'error');
                }
                
                log('üéâ Teste de acesso conclu√≠do!', 'success');
                
            } catch (error) {
                log(`‚ùå Erro no teste: ${error.message}`, 'error');
            }
        };

        // Initialize
        log('üöÄ Ferramenta de migra√ß√£o carregada');
        log('üìã Siga os passos na ordem: Login ‚Üí Verificar ‚Üí Migrar ‚Üí Testar');
        updateButtonStates();
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>Reestrutura√ß√£o de Cole√ß√µes Firestore</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
        .button { background: #4285f4; color: white; border: none; padding: 15px 30px; margin: 10px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .button:hover { background: #3367d6; }
        .button:disabled { background: #ccc; cursor: not-allowed; }
        .button.danger { background: #dc3545; }
        .button.danger:hover { background: #c82333; }
        .button.success { background: #28a745; }
        .button.success:hover { background: #218838; }
        .log { background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .success { color: #0f5132; background: #d1e7dd; }
        .error { color: #842029; background: #f8d7da; }
        .warning { color: #664d03; background: #fff3cd; }
        .info { color: #055160; background: #cff4fc; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .step h3 { margin-top: 0; }
        .mapping-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .mapping-table th, .mapping-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .mapping-table th { background-color: #f2f2f2; }
        .report { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üîÑ Reestrutura√ß√£o de Cole√ß√µes Firestore</h1>
    <p>Esta ferramenta ir√° migrar as cole√ß√µes para a nova estrutura padronizada com nomes em ingl√™s.</p>
    
    <div class="step">
        <h3>üìã Mapeamento de Cole√ß√µes</h3>
        <table class="mapping-table">
            <thead>
                <tr>
                    <th>Cole√ß√£o Atual (Portugu√™s)</th>
                    <th>Nova Cole√ß√£o (Ingl√™s)</th>
                    <th>Descri√ß√£o</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>alunos</td><td>students</td><td>Dados dos alunos</td></tr>
                <tr><td>instrutores</td><td>instructors</td><td>Dados dos instrutores</td></tr>
                <tr><td>turmas</td><td>classes</td><td>Turmas/aulas</td></tr>
                <tr><td>pagamentos</td><td>payments</td><td>Pagamentos</td></tr>
                <tr><td>planos</td><td>plans</td><td>Planos de pagamento</td></tr>
                <tr><td>eventRegistrations</td><td>event_registrations</td><td>Inscri√ß√µes em eventos</td></tr>
            </tbody>
        </table>
    </div>
    
    <div class="step">
        <h3>Passo 1: Login</h3>
        <p>Fa√ßa login com um usu√°rio admin para executar a migra√ß√£o.</p>
        <button class="button" onclick="doLogin()" id="loginBtn">üîê Fazer Login</button>
        <div id="loginStatus"></div>
    </div>
    
    <div class="step">
        <h3>Passo 2: Simula√ß√£o da Migra√ß√£o</h3>
        <p>Execute uma simula√ß√£o para ver o que ser√° migrado (sem alterar dados).</p>
        <button class="button" onclick="runDryRun()" id="dryRunBtn" disabled>üß™ Simular Migra√ß√£o</button>
    </div>
    
    <div class="step">
        <h3>Passo 3: Migra√ß√£o Real</h3>
        <p><strong>‚ö†Ô∏è ATEN√á√ÉO:</strong> Esta opera√ß√£o ir√° copiar dados para as novas cole√ß√µes.</p>
        <button class="button danger" onclick="runMigration()" id="migrateBtn" disabled>üöÄ Executar Migra√ß√£o</button>
    </div>
    
    <div class="step">
        <h3>Passo 4: Aplicar Novas Regras</h3>
        <p>Aplique as novas regras de seguran√ßa ap√≥s a migra√ß√£o.</p>
        <button class="button success" onclick="deployNewRules()" id="rulesBtn" disabled>üìã Aplicar Novas Regras</button>
    </div>
    
    <div id="migrationReport" class="report" style="display: none;">
        <h3>üìä Relat√≥rio de Migra√ß√£o</h3>
        <div id="reportContent"></div>
    </div>
    
    <div id="log" class="log"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA_hzFPt9hUITlMq9BrsJuxAdzycVR3AEI",
            authDomain: "academia-app-5cf79.firebaseapp.com",
            projectId: "academia-app-5cf79",
            storageBucket: "academia-app-5cf79.firebasestorage.app",
            messagingSenderId: "377489252583",
            appId: "1:377489252583:android:87f2c3948511325769c242"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const functions = getFunctions(app);

        let currentUser = null;
        let migrationCompleted = false;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateButtonStates() {
            const isLoggedIn = !!currentUser;
            document.getElementById('dryRunBtn').disabled = !isLoggedIn;
            document.getElementById('migrateBtn').disabled = !isLoggedIn;
            document.getElementById('rulesBtn').disabled = !migrationCompleted;
            document.getElementById('loginBtn').textContent = isLoggedIn ? '‚úÖ Logado' : 'üîê Fazer Login';
        }

        function displayMigrationReport(report) {
            const reportDiv = document.getElementById('migrationReport');
            const contentDiv = document.getElementById('reportContent');
            
            let html = `<p><strong>Total de documentos:</strong> ${report.totalDocuments}</p>`;
            html += `<p><strong>Erros:</strong> ${report.errors}</p>`;
            html += `<p><strong>Modo:</strong> ${report.dryRun ? 'Simula√ß√£o' : 'Migra√ß√£o Real'}</p>`;
            
            if (report.report && report.report.length > 0) {
                html += '<h4>Detalhes por Academia:</h4>';
                html += '<table class="mapping-table"><thead><tr><th>Academia</th><th>Cole√ß√£o</th><th>Documentos</th><th>Status</th></tr></thead><tbody>';
                
                report.report.forEach(item => {
                    const statusClass = item.status === 'error' ? 'error' : item.status === 'migrated' ? 'success' : 'info';
                    html += `<tr class="${statusClass}">`;
                    html += `<td>${item.gym}</td>`;
                    html += `<td>${item.collection}</td>`;
                    html += `<td>${item.documents}</td>`;
                    html += `<td>${item.status}${item.error ? ` - ${item.error}` : ''}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            }
            
            contentDiv.innerHTML = html;
            reportDiv.style.display = 'block';
        }

        // Monitor auth state
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateButtonStates();
            
            if (user) {
                document.getElementById('loginStatus').innerHTML = `<div class="success">‚úÖ Logado como: ${user.email}</div>`;
                log(`‚úÖ Usu√°rio logado: ${user.email}`, 'success');
            } else {
                document.getElementById('loginStatus').innerHTML = '';
            }
        });

        window.doLogin = async function() {
            try {
                if (currentUser) {
                    log('‚ÑπÔ∏è Usu√°rio j√° est√° logado', 'info');
                    return;
                }

                const email = prompt('Email do usu√°rio admin:', 'admin@example.com');
                const password = prompt('Senha:');
                
                if (!email || !password) {
                    log('‚ùå Email ou senha n√£o fornecidos', 'error');
                    return;
                }

                log('üîê Fazendo login...');
                await signInWithEmailAndPassword(auth, email, password);
                log('‚úÖ Login realizado com sucesso!', 'success');
                
            } catch (error) {
                log(`‚ùå Erro no login: ${error.message}`, 'error');
            }
        };

        window.runDryRun = async function() {
            try {
                if (!currentUser) {
                    log('‚ùå Usu√°rio n√£o est√° logado', 'error');
                    return;
                }

                log('üß™ Iniciando simula√ß√£o de migra√ß√£o...');
                log('‚ÑπÔ∏è Esta opera√ß√£o apenas simula a migra√ß√£o, sem alterar dados', 'info');
                
                const migrateFunction = httpsCallable(functions, 'migrateCollections');
                const result = await migrateFunction({ dryRun: true });
                
                log(`‚úÖ Simula√ß√£o conclu√≠da!`, 'success');
                log(`üìä Documentos que seriam migrados: ${result.data.totalDocuments}`, 'info');
                log(`‚ùå Erros encontrados: ${result.data.errors}`, result.data.errors > 0 ? 'warning' : 'info');
                
                displayMigrationReport(result.data);
                
            } catch (error) {
                log(`‚ùå Erro na simula√ß√£o: ${error.message}`, 'error');
            }
        };

        window.runMigration = async function() {
            try {
                if (!currentUser) {
                    log('‚ùå Usu√°rio n√£o est√° logado', 'error');
                    return;
                }

                const confirmation = confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta opera√ß√£o ir√° migrar dados para as novas cole√ß√µes. Tem certeza que deseja continuar?');
                if (!confirmation) {
                    log('‚ùå Migra√ß√£o cancelada pelo usu√°rio', 'warning');
                    return;
                }

                log('üöÄ Iniciando migra√ß√£o real...');
                log('‚è≥ Esta opera√ß√£o pode levar alguns minutos...', 'warning');
                
                const migrateFunction = httpsCallable(functions, 'migrateCollections');
                const result = await migrateFunction({ dryRun: false });
                
                log(`‚úÖ Migra√ß√£o conclu√≠da com sucesso!`, 'success');
                log(`üìä Documentos migrados: ${result.data.totalDocuments}`, 'success');
                log(`‚ùå Erros: ${result.data.errors}`, result.data.errors > 0 ? 'warning' : 'success');
                
                displayMigrationReport(result.data);
                migrationCompleted = true;
                updateButtonStates();
                
                log('üéØ Pr√≥ximo passo: Aplicar as novas regras de seguran√ßa', 'info');
                
            } catch (error) {
                log(`‚ùå Erro na migra√ß√£o: ${error.message}`, 'error');
            }
        };

        window.deployNewRules = async function() {
            log('üìã Para aplicar as novas regras de seguran√ßa:', 'info');
            log('1. Execute: firebase deploy --only firestore:rules', 'info');
            log('2. Use o arquivo: firestore-new.rules', 'info');
            log('3. Teste a aplica√ß√£o com as novas cole√ß√µes', 'info');
            log('‚ö†Ô∏è Esta opera√ß√£o deve ser feita via terminal/CLI', 'warning');
        };

        // Initialize
        log('üöÄ Ferramenta de reestrutura√ß√£o carregada');
        log('üìã Siga os passos na ordem: Login ‚Üí Simular ‚Üí Migrar ‚Üí Aplicar Regras');
        updateButtonStates();
    </script>
</body>
</html>
